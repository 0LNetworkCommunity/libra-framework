use anyhow::Context;
use libra_smoke_tests::libra_smoke::LibraSmoke;

use libra_txs::submit_transaction::Sender;
use libra_types::legacy_types::{app_cfg::Profile, block::VDFProof};
use libra_wallet::account_keys;

// Scenario: a new user can start a new tower chain
// 1. a validator, Val 0, will create a new user Alice by transferring funds
// 2. Alice can use a Proof 0, the first miner proof and successfully submit

/// Testing that we can get a swarm up with the current head.mrb
#[tokio::test(flavor = "multi_thread", worker_threads = 1)]
async fn tower_newbie() -> anyhow::Result<()> {
    // create libra swarm and get app config for the first validator
    let mut ls = LibraSmoke::new(Some(1))
        .await
        .expect("could not start libra smoke");
    let mut val_app_cfg = ls.first_account_app_cfg()?;

    // get an appcfg struct from Alice's mnemonic
    let alice = account_keys::get_keys_from_mnem("talent sunset lizard pill fame nuclear spy noodle basket okay critic grow sleep legend hurry pitch blanket clerk impose rough degree sock insane purse".to_owned())?;
    let alice_acct = &alice.child_0_owner.account;

    // create an account for alice by transferring funds
    let mut s = Sender::from_app_cfg(&val_app_cfg, None).await?;
    let res = s
        .transfer(alice.child_0_owner.account, 100.0, false)
        .await
        .context("could not create account")?
        .unwrap();
    assert!(res.info.status().is_success());

    // alice submits the genesis fixture proof
    let proof: VDFProof = serde_json::from_str(
        r#"{
      "height": 0,
      "elapsed_secs": 0,
      "preimage": "87515d94a244235a1433d7117bc0cb154c613c2f4b1e67ca8d98a542ee3f59f500000000000000000074657374696e6764000000000000000002000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000050726f74657374732072616765206163726f737320746865206e6174696f6e",
      "proof": "0003ee672c5d3b987e8914fc17e29e8191c460c27d150f278249755b93eb52dbbefffe97a0c0aaf31bf95c90700a173d649e2b0d9239ee73168d6f350d5b7bf197bd",
      "difficulty": 100,
      "security": 512
    }"#,
    )?;

    // let's reuse the validators AppCfg since it has all the connection info we want.
    let mut p = Profile::new(alice.child_0_owner.auth_key, alice.child_0_owner.account);
    assert!(alice_acct == &p.account);

    p.set_private_key(&alice.child_0_owner.pri_key);

    val_app_cfg.maybe_add_profile(p)?;

    let mut alice_sender = Sender::from_app_cfg(
        &val_app_cfg,
        Some(alice.child_0_owner.account.to_string()),
    )
    .await?;

    assert!(alice_acct == &alice_sender.local_account.address());

    let res = alice_sender.commit_proof(proof).await?;
    assert!(res.info.status().is_success());

    Ok(())
}
